# 1. Un-indexed Parameters in Events
Consider indexing parameters for events, serving as logs filter when looking for specifically wanted data. Up to three parameters in an event function can receive the attribute indexed which will cause the respective arguments to be treated as log topics instead of data. Here is one of the instances entailed:

- [Link to code](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/BathHouseV2.sol#L24-L25)
```js
File: contracts/RubiconMarket.sol
23:    event BathTokenCreated(address bathToken, address underlying);
24:    event BuddySpawned(address bathToken, address bathBuddy);
```
- [Link to code](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/periphery/BathBuddy.sol#L266)
```js
File: contracts/periphery/BathBuddy.sol
266:    event Recovered(address token, uint256 amount);
```
# 2. Sanity/Threshold/Limit Checks
```_owner, newBud, _bathHouse``` not checked for validation
- [Link to code](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/periphery/BathBuddy.sol#L77-L79)
```js
File: contracts/periphery/BathBuddy.sol
77:        owner = _owner;
78:        myBathTokenBuddy = newBud;
79:        bathHouse = _bathHouse;
```
```_comptroller, _pAdmin``` not checked for validation
- [BathHouseV2.sol#L34](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/BathHouseV2.sol#L34)
- [BathHouseV2.sol#L36](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/BathHouseV2.sol#L36)
```js
File: contracts/BathHouseV2.sol
34:        comptroller = Comptroller(_comptroller);

36:        proxyAdmin = _pAdmin;
```
```owner_``` not checked for validation
- [RubiconMarket.sol#L26](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L26)
```js
File: contracts/BathHouseV2.sol

26:        owner = owner_;
```
```recipient, owner``` not checked for validation
- [RubiconMarket.sol#L532-L533](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L532-L533)
```js
File: contracts/BathHouseV2.sol

532:        info.recipient = recipient;
533:        info.owner = owner;
```
- [V2Migrator.sol#L33](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/V2Migrator.sol#L33)
```js
File: contracts/V2Migrator.sol

    constructor(address[] memory bathTokensV1, address[] memory bathTokensV2) {
        for (uint256 i = 0; i < bathTokensV1.length; ++i) {
            // set v1 to v2 bathTokens
33:            v1ToV2Pools[bathTokensV1[i]] = bathTokensV2[i];
        }
    }
```
- [Position.sol#L55-L57](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/poolsUtility/Position.sol#L55-L57)
```_oracle, _rubiconMarket, _bathHouseV2``` not checked for validation
```js
File: contracts/utilities/poolsUtility/Position.sol

    constructor(address _oracle, address _rubiconMarket, address _bathHouseV2) {
55:        oracle = PriceOracle(_oracle);
56:        rubiconMarket = RubiconMarket(_rubiconMarket);
57:        bathHouseV2 = BathHouseV2(_bathHouseV2);
58:        comptroller = bathHouseV2.comptroller();
    }
```
# 3.  Inadequate NatSpec
Solidity contracts can use a special form of comments, i.e., the Ethereum Natural Language Specification Format (NatSpec) to provide rich documentation for functions, return variables and more. Please visit the following link for further details:
[NatSpec](https://docs.soliditylang.org/en/v0.8.16/natspec-format.html)

In the following source files not used NETSPEC.
- [RubiconMarket.sol](https://github.com/code-423n4/2023-04-rubicon/blob/main/contracts/RubiconMarket.sol)
- [BathHouseV2.sol](https://github.com/code-423n4/2023-04-rubicon/blob/main/contracts/BathHouseV2.sol)
- [V2Migrator.sol](https://github.com/code-423n4/2023-04-rubicon/blob/main/contracts/V2Migrator.sol)
- [BathBuddy.sol](https://github.com/code-423n4/2023-04-rubicon/blob/main/contracts/periphery/BathBuddy.sol)
- [Position.sol](https://github.com/code-423n4/2023-04-rubicon/blob/main/contracts/utilities/poolsUtility/Position.sol)
- [FeeWrapper.sol](https://github.com/code-423n4/2023-04-rubicon/blob/main/contracts/utilities/FeeWrapper.sol)

# 4. Lines Too Long
Lines in source code are typically limited to 80 characters, but it’s reasonable to stretch beyond this limit when need be as monitor screens theses days are comparatively larger. Considering the files will most likely reside in GitHub that will have a scroll bar automatically kick in when the length is over 164 characters, all code lines and comments should be split when/before hitting this length. Keep line width to max 120 characters for better readability where possible.
- [BathBuddy.sol#L28](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/periphery/BathBuddy.sol#L28)

# 5. Function Calls in Loop Could Lead to Denial of Service
Function calls made in unbounded loop are error-prone with potential resource exhaustion as it can trap the contract due to the gas limitations or failed transactions.
- [BathHouseV2.sol#L123](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/BathHouseV2.sol#L123)
```js
File: contracts/BathHouseV2.sol

123:        for (uint256 i = 0; i < buddies.length; ++i) {
```
- [RubiconMarket.sol#L899](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L899)
- [RubiconMarket.sol#L911](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L911)
- [RubiconMarket.sol#L924](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L924)

```js
File: contracts/RubiconMarket.sol

899:        for (uint i = 0; i < payAmts.length; i++) {

911:        for (uint i = 0; i < ids.length; i++) {

924:        for (uint i = 0; i < ids.length; i++) {
```
- [V2Migrator.sol#L31](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/V2Migrator.sol#L31)
```js
File: contracts/V2Migrator.sol

31:        for (uint256 i = 0; i < bathTokensV1.length; ++i) {
```
- [FeeWrapper.sol#L40](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/FeeWrapper.sol#L40)

```js
File: contracts/utilities/FeeWrapper.sol

40:        for (uint256 i = 0; i < tokenAmounts.length; ++i) {
```

# 6. Events Associated With Setter Functions
Consider having events associated with setter functions emit both the new and old values instead of just the new value.
- [RubiconMarket.sol#L17](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L17)
```js
File: contracts/RubiconMarket.sol
17:    event LogSetOwner(address indexed owner);
```
- [BathBuddy.sol#L265](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/periphery/BathBuddy.sol#L265)
```js
File: contracts/periphery/BathBuddy.sol

265:    event RewardsDurationUpdated(uint256 newDuration);
```
# 7. The ```nonReentrant``` should occur before all other modifiers
- [RubiconMarket.sol#L833](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L833)
- [RubiconMarket.sol#L859](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L859)
- [RubiconMarket.sol#L874](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L874)
```js
File: contracts/RubiconMarket.sol

833:    ) public can_offer returns (uint256) {
834:        require(!locked, "Reentrancy attempt");

858:    ) public override can_buy(id) returns (bool) {
859:        require(!locked, "Reentrancy attempt");

873:    ) public override can_cancel(id) returns (bool success) {
874:        require(!locked, "Reentrancy attempt");
```
# 8. Missing event for critical parameter change

- [BathBuddy.sol#L71-L85](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/periphery/BathBuddy.sol#L71-L85)
```js
File: contracts/periphery/BathBuddy.sol

    function spawnBuddy(
        address _owner,
        address newBud,
        address _bathHouse
    ) external {
        require(!friendshipStarted, "I already have a buddy!");
        owner = _owner;
        myBathTokenBuddy = newBud;
        bathHouse = _bathHouse;

        // Note, rewards duration must be set by admin

        // Constructor pattern
        friendshipStarted = true;
    }
```
- [BathHouseV2.sol#L32-L39](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/BathHouseV2.sol#L32-L39)
```js
File: contracts/BathHouseV2.sol

    function initialize(address _comptroller, address _pAdmin) external {
        require(!initialized, "BathHouseV2 already initialized!");
        comptroller = Comptroller(_comptroller);
        admin = msg.sender;
        proxyAdmin = _pAdmin;

        initialized = true;
    }
```
- [RubiconMarket.sol#L1466-L1469](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1466-L1469)
```js
File: contracts/RubiconMarket.sol

    function setFeeBPS(uint256 _newFeeBPS) external auth returns (bool) {
        feeBPS = _newFeeBPS;
        return true;
    }
```
- [RubiconMarket.sol#L1476-L1480](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1476-L1480)
```js
File: contracts/RubiconMarket.sol

    function setFeeTo(address newFeeTo) external auth returns (bool) {
        require(newFeeTo != address(0));
        feeTo = newFeeTo;
        return true;
    }
```
# 9. Use a more recent version of solidity
Use a solidity version of at least 0.8.13 to get the ability to ```use using for``` with a list of free functions.
- [BathBuddy.sol#L2](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/periphery/BathBuddy.sol#L2)
```js
File: contracts/periphery/BathBuddy.sol

1:  // SPDX-License-Identifier: MIT
2:  pragma solidity ^0.8.0;
```
# 10. Use a more recent version of solidity
- Use a solidity version of at least 0.8.4 to get ```bytes.concat()``` instead of ```abi.encodePacked(<bytes>,<bytes>)```.
- Use a solidity version of at least 0.8.12 to get ```string.concat()``` instead of ```abi.encodePacked(<str>,<str>)```.
- [BathBuddy.sol#L2](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/periphery/BathBuddy.sol#L2)
```js
File: contracts/periphery/BathBuddy.sol

1:  // SPDX-License-Identifier: MIT
2:  pragma solidity ^0.8.0;
```
- [RubiconMarket.sol#L2](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L2)
```js
File: contracts/RubiconMarket.sol

1:  // SPDX-License-Identifier: AGPL-3.0
2:  pragma solidity ^0.8.9;
```
# 11.  Not using the named return variables anywhere in the function is confusing.
Consider changing the variable to be an unnamed one.
- [BathHouseV2.sol#L53](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/BathHouseV2.sol#L53)
- [BathHouseV2.sol#L142](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/BathHouseV2.sol#L142)
```js
File: contracts/BathHouseV2.sol

53:    ) external view returns (address buddy) {

142:        returns (string memory _name, string memory _symbol, uint8 _decimals)
```
- [RubiconMarket.sol#L46](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L46)
- [RubiconMarket.sol#L50](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L50)
- [RubiconMarket.sol#L54](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L54)
- [RubiconMarket.sol#L58](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L58)
- [RubiconMarket.sol#L62](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L62)
- [RubiconMarket.sol#L66](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L66)
- [RubiconMarket.sol#L70](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L70)
- [RubiconMarket.sol#L77](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L77)
- [RubiconMarket.sol#L81](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L81)
- [RubiconMarket.sol#L85](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L85)
- [RubiconMarket.sol#L89](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L89)
- [RubiconMarket.sol#L276](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L276)
- [RubiconMarket.sol#L280](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L280)
- [RubiconMarket.sol#L284](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L284)
- [RubiconMarket.sol#L454](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L454)
- [RubiconMarket.sol#L496](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L496)
- [RubiconMarket.sol#L580](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L580)
- [RubiconMarket.sol#L620](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L620)
- [RubiconMarket.sol#L873](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L873)
- [RubiconMarket.sol#L1033](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1033)
- [RubiconMarket.sol#L1074](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1074)
- [RubiconMarket.sol#L1119](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1119)
- [RubiconMarket.sol#L1128](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1128)
- [RubiconMarket.sol#L1153](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1153)
- [RubiconMarket.sol#L1161](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1161)
- [RubiconMarket.sol#L1282](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1282)
```js
File: contracts/RubiconMarket.sol

46:    function add(uint256 x, uint256 y) internal pure returns (uint256 z) {

50:    function sub(uint256 x, uint256 y) internal pure returns (uint256 z) {

54:    function mul(uint256 x, uint256 y) internal pure returns (uint256 z) {

58:    function min(uint256 x, uint256 y) internal pure returns (uint256 z) {

62:    function max(uint256 x, uint256 y) internal pure returns (uint256 z) {

66:    function imin(int256 x, int256 y) internal pure returns (int256 z) {

70:    function imax(int256 x, int256 y) internal pure returns (int256 z) {

77:    function wmul(uint256 x, uint256 y) internal pure returns (uint256 z) {

81:    function rmul(uint256 x, uint256 y) internal pure returns (uint256 z) {

85:    function wdiv(uint256 x, uint256 y) internal pure returns (uint256 z) {

89:    function rdiv(uint256 x, uint256 y) internal pure returns (uint256 z) {

276:    function isActive(uint256 id) public view returns (bool active) {

280:    function getOwner(uint256 id) public view returns (address owner) {

284:    function getRecipient(uint256 id) public view returns (address owner) {

454:    ) public virtual can_cancel(id) synchronized returns (bool success) {

496:    ) external virtual returns (bytes32 id) {

518:    ) public virtual can_offer synchronized returns (uint256 id) {

580:    ) public view returns (uint256 _amount) {

620:    function isClosed() public pure returns (bool closed) {

873:    ) public override can_cancel(id) returns (bool success) {

1033:    ) external returns (uint256 fill_amt) {

1074:    ) external returns (uint256 fill_amt) {

1119:    ) external view returns (uint256 fill_amt) {

1128:    ) public view returns (uint256 fill_amt) {

1153:    ) public view returns (uint256 fill_amt) {

1161:    ) public view returns (uint256 fill_amt) {

1282:    ) internal returns (uint256 id) {
```
- [FeeWrapper.sol#L35](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/FeeWrapper.sol#L35)
- [FeeWrapper.sol#L110](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/FeeWrapper.sol#L110)
```js
File: contracts/utilities/FeeWrapper.sol

35:        returns (uint256[] memory amountsWithFee, uint256[] memory fees)

110:    ) internal returns (uint256 _msgValue) {
```
- [Position.sol#L74](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/poolsUtility/Position.sol#L74)
- [Position.sol#L86](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/poolsUtility/Position.sol#L86)
- [Position.sol#L130](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/poolsUtility/Position.sol#L130)
- [Position.sol#L258](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/poolsUtility/Position.sol#L258)
- [Position.sol#L308](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/poolsUtility/Position.sol#L308)
- [Position.sol#L326](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/poolsUtility/Position.sol#L326)
- [Position.sol#L354](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/poolsUtility/Position.sol#L354)
- [Position.sol#L531](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/poolsUtility/Position.sol#L531)

# 12. ```Function writing``` that does not comply with the ```Solidity Style Guide```
Order of Functions; ordering helps readers identify which functions they can call and to find the constructor and fallback definitions easier. But there are contracts in the project that do not comply with this.
[soliditylang-style-guide](https://docs.soliditylang.org/en/v0.8.17/style-guide.html)
Functions should be grouped according to their visibility and ordered:

constructor

receive function (if exists)

fallback function (if exists)

external

public

internal

private

within a grouping, place the view and pure functions last.
4 instances.
- [RubiconMarket.sol](https://github.com/code-423n4/2023-04-rubicon/blob/main/contracts/RubiconMarket.sol)
- [BathHouseV2.sol](https://github.com/code-423n4/2023-04-rubicon/blob/main/contracts/BathHouseV2.sol)
- [BathBuddy.sol](https://github.com/code-423n4/2023-04-rubicon/blob/main/contracts/periphery/BathBuddy.sol)
- [Position.sol](https://github.com/code-423n4/2023-04-rubicon/blob/main/contracts/utilities/poolsUtility/Position.sol)
# 13. Open TODOs
Code architecture, incentives, and error handling/reporting questions/issues should be resolved before deployment.
- [RubiconMarket.sol#L99](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L99)
- [RubiconMarket.sol#L128](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L128)
- [RubiconMarket.sol#L184](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L184)
- [RubiconMarket.sol#L197](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L197)
- [RubiconMarket.sol#L299](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L299)
- [RubiconMarket.sol#L428](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L428)
- [RubiconMarket.sol#L661](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L661)
- [RubiconMarket.sol#L663](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L663)
- [RubiconMarket.sol#L666](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L666)
- [RubiconMarket.sol#L675](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L675)
```js
File: contracts/RubiconMarket.sol

99:    /// TODO: double check it is sound logic to kill this event

128:    /// TODO: double check it is sound logic to kill this event

184:    /// TODO: double check it is sound logic to kill this event

197:    /// TODO: we will need to make sure this emit is included in any taker pay maker scenario

299:   /// TODO: double check it is sound logic to kill this event

428:   /// TODO: double check it is sound logic to kill this event

661:    /// event LogBuyEnabled(bool isEnabled); /// TODO: this event is not used in the contract, remove?

663:    /// event LogMatchingEnabled(bool isEnabled); /// TODO: this event is not used in the contract, remove?

666:    /// event LogInsert(address keeper, uint256 id); /// TODO: this event is not used in the contract, remove?

675:    bool public buyEnabled = true; //buy enabled TODO: review this decision!
```
- [BathBuddy.sol#L37](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/periphery/BathBuddy.sol#L37)
- [BathBuddy.sol#L92](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/periphery/BathBuddy.sol#L92)
```js
File: contracts/periphery/BathBuddy.sol

37:     // TODO: not really the case anymore ^

92:     // TODO: do we need this?
```
- [Position.sol#L156](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/poolsUtility/Position.sol#L156)

```js
File: contracts/utilities/poolsUtility/Position.sol

156:    // TODO: definitely need to work on naming things
```
# 14. Return values of approve() not checked.
- [FeeWrapper.sol#L105](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/FeeWrapper.sol#L105)

```js
File: contracts/utilities/FeeWrapper.sol

105:        IERC20(_feeToken).approve(_target, (_totalAmount - _feeAmount));
```
- [Position.sol#L465](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/poolsUtility/Position.sol#L465)
- [Position.sol#L500](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/poolsUtility/Position.sol#L500)

```js
File: contracts/utilities/poolsUtility/Position.sol

465:        IERC20(_quote).approve(address(rubiconMarket), _maxFill);

500:        IERC20(_asset).approve(
501:                address(rubiconMarket),
502:                IERC20(_asset).balanceOf(address(this))
503:            );
```
# 15. Division by magic number like ```10 ** 18``` or ```10 ** 9```
It is recommended to divide by constant variables instead of a number ```10 ** 18```
The change would improve code readability and flexibility.
- [RubiconMarket.sol#L338](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L338)
- [RubiconMarket.sol#L346](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L346)
- [RubiconMarket.sol#L583](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L583)
- [RubiconMarket.sol#L586](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L586)
- [RubiconMarket.sol#L1058](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1058)
- [RubiconMarket.sol#L1060](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1060)
- [RubiconMarket.sol#L1099](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1099)
- [RubiconMarket.sol#L1101](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1101)
- [RubiconMarket.sol#L1141](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1141)
- [RubiconMarket.sol#L1144](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1144)
- [RubiconMarket.sol#L1175](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1175)
- [RubiconMarket.sol#L1177](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1177)
```js
File: contracts/RubiconMarket.sol

338:        uint256 fee = mul(spend, feeBPS) / 100_000;

346:        uint256 mFee = mul(spend, makerFee()) / 100_000;

583:        _amount -= mul(amount, feeBPS) / 100_000;

856:        _amount -= mul(amount, makerFee()) / 100_000;

1057:       uint256 baux = rmul(
1058:            mul(pay_amt, 10 ** 9),
1059:            rdiv(offers[offerId].pay_amt, offers[offerId].buy_amt)
1060:       ) / 10 ** 9;

1098:       rmul(
1099:            mul(buy_amt, 10 ** 9),
1100:            rdiv(offers[offerId].buy_amt, offers[offerId].pay_amt)
1101:       ) / 10 ** 9

1141:        rmul(
1142:            mul(pay_amt, 10 ** 9),
1143:            rdiv(offers[offerId].pay_amt, offers[offerId].buy_amt)
1144:        ) / 10 ** 9

1175        mul(buy_amt, 10 ** 9),
1176            rdiv(offers[offerId].buy_amt, offers[offerId].pay_amt)
1177        ) / 10 ** 9
```
- [Position.sol#L331](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/poolsUtility/Position.sol#L331)
```js
File: contracts/utilities/poolsUtility/Position.sol

331        ).div(10 ** 18);
```
# 16. Prevent division by 0.
These functions can be called with 0 value in the input, this value is not checked for being bigger than 0, that means in some scenarios this can potentially trigger a division by zero.
- [FeeWrapper.sol#L41](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/FeeWrapper.sol#L41)
```js
File: contracts/utilities/FeeWrapper.sol

41:        fees[i] = (tokenAmounts[i] * feeValue) / feeType;
```
# 17. Consider using OpenZeppelin’s SafeCast library to prevent unexpected overflows when casting from uint256.
- [RubiconMarket.sol#L321-L322](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L321-L322)
- [RubiconMarket.sol#L519-L520](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L519-L520)
- [RubiconMarket.sol#L559-L560](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L559-L560)

```js
File: contracts/RubiconMarket.sol

321:        require(uint128(spend) == spend, "spend is not an int");
322:        require(uint128(quantity) == quantity, "quantity is not an int");

519:        require(uint128(pay_amt) == pay_amt);
520:        require(uint128(buy_amt) == buy_amt);

559:        uint128(pay_amt),
560:        uint128(buy_amt)
```
# 18. use ```uint256``` instead of ```uint``` in the following instances:
Interchangeable usage of uint and uint256
- [RubiconMarket.sol#L888](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L888)
- [RubiconMarket.sol#L890](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L890)
- [RubiconMarket.sol#L899](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L899)
- [RubiconMarket.sol#L899](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L899)
- [RubiconMarket.sol#L910-L911](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L910-L911)
- [RubiconMarket.sol#L918-L919](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L918-L919)
- [RubiconMarket.sol#L921](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L921)
- [RubiconMarket.sol#L924](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L924)
```js
File: contracts/RubiconMarket.sol

        function batchOffer(
888:        uint[] calldata payAmts,
            address[] calldata payGems,
890:        uint[] calldata buyAmts,
            address[] calldata buyGems
        ) external {
            require(
                payAmts.length == payGems.length &&
                    payAmts.length == buyAmts.length &&
                    payAmts.length == buyGems.length,
                "Array lengths do not match"
            );
899:        for (uint i = 0; i < payAmts.length; i++) {
                this.offer(
                    payAmts[i],
                    ERC20(payGems[i]),
                    buyAmts[i],
                    ERC20(buyGems[i])
                );
            }
        }

    /// @notice Cancel multiple offers in a single transaction
910:    function batchCancel(uint[] calldata ids) external {
911:        for (uint i = 0; i < ids.length; i++) {
                cancel(ids[i]);
            }
        }

    /// @notice Update outstanding offers to new offers, in a batch, in a single transaction
        function batchRequote(
918:        uint[] calldata ids,
919:        uint[] calldata payAmts,
            address[] calldata payGems,
921:        uint[] calldata buyAmts,
            address[] calldata buyGems
        ) external {
924:        for (uint i = 0; i < ids.length; i++) {
                cancel(ids[i]);
                this.offer(
                    payAmts[i],
                    ERC20(payGems[i]),
                    buyAmts[i],
                    ERC20(buyGems[i])
                );
            }
        }
```

# 19. Use ```2StepSetOwner``` instead of ```setOwner```
- [RubiconMarket.sol#L25](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L25)
```js
File: contracts/RubiconMarket.sol

25:    function setOwner(address owner_) external auth {
26:        owner = owner_;
27:        emit LogSetOwner(owner);
28:    }
```
# 20. ```initialize()``` function can be called by anybody.
- [BathHouseV2.sol#L32](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/BathHouseV2.sol#L32)
More importantly, if someone else runs this function, they will have authority  of ```owner``` or ```admin``` because of the ```owner``` and ```admin``` state variables.
```js
File: contracts/BathHouseV2.sol

32:    function initialize(address _comptroller, address _pAdmin) external {
33:        require(!initialized, "BathHouseV2 already initialized!");
34:        comptroller = Comptroller(_comptroller);
35:        admin = msg.sender;
36:        proxyAdmin = _pAdmin;

38:        initialized = true;
39:    }
```
- [RubiconMarket.sol#L700](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L700)
```js
File: contracts/RubiconMarket.sol

700:    function initialize(address _feeTo) public {
701:        require(!initialized, "contract is already initialized");
702:        require(_feeTo != address(0));

704:        /// @notice The market fee recipient
705:        feeTo = _feeTo;

707:        owner = msg.sender;
708:         emit LogSetOwner(msg.sender);

710:        /// @notice The starting fee on taker trades in basis points
711:        feeBPS = 1;

713:       initialized = true;
714:        matchingEnabled = true;
715:        buyEnabled = true;
716:    }
```
Add a control that makes ```initialize()``` only call the Deployer Contract or EOA;
```js
        if (msg.sender != DEPLOYER_ADDRESS) {
            revert NotDeployer();
        }
```
# 21. Add a timelock to critical functions
It is a good practice to give time for users to react and adjust to critical changes. A timelock provides more guarantees and reduces the level of trust required, thus decreasing risk for users. It also indicates that the project is legitimate (less risk of a malicious owner making a sandwich attack on a user). Consider adding a timelock to:
- [RubiconMarket.sol#L25](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L25)
```js
File: contracts/RubiconMarket.sol

25:    function setOwner(address owner_) external auth {
26:        owner = owner_;
27:        emit LogSetOwner(owner);
28:    }
```
# 22. For modern and more readable code; update import usages.
Solidity code is also cleaner in another way that might not be noticeable: the struct Point. We were importing it previously with global import but not using it. The Point struct polluted the source code with an unnecessary object we were not using because we did not need it.

This was breaking the rule of modularity and modular programming: only import what you need Specific imports with curly braces allow us to apply this rule better.

Context: All Contracts.
- [BathBuddy.sol#L4-L7](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/periphery/BathBuddy.sol#L4-L7)
```js
File: contracts/periphery/BathBuddy.sol

4:  import "@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol";
5:  import "@openzeppelin/contracts/security/ReentrancyGuard.sol";
6:  import "@openzeppelin/contracts/utils/math/SafeMath.sol";
7:  import "@openzeppelin/contracts/security/Pausable.sol";
```
- [RubiconMarket.sol#L11-L12](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L11-L12)
```js
File: contracts/RubiconMarket.sol

11: import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
12: import "@openzeppelin/contracts/utils/StorageSlot.sol";
```
- [V2Migrator.sol#L4-L6](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/V2Migrator.sol#L4-L6)
```js
File: contracts/V2Migrator.sol

4:  import "@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol";
5:  import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
6:  import "./compound-v2-fork/CTokenInterfaces.sol";
```
- [BathHouseV2.sol#L4-L9](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/BathHouseV2.sol#L4-L9)
```js
File: contracts/BathHouseV2.sol

4:  import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
5:  import "./compound-v2-fork/InterestRateModel.sol";
6:  import "./compound-v2-fork/CErc20Delegator.sol";
7:  import "./compound-v2-fork/Comptroller.sol";
8:  import "./compound-v2-fork/Unitroller.sol";
9:  import "./periphery/BathBuddy.sol";
```
- [Position.sol#L4-L11](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/poolsUtility/Position.sol#L4-L11)
```js
File: contracts/utilities/poolsUtility/Position.sol

4:  import "@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol";
5:  import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
6:  import "@openzeppelin/contracts/utils/math/SafeMath.sol";
7:  import "@openzeppelin/contracts/access/Ownable.sol";
8:  import "../../compound-v2-fork/Comptroller.sol";
9:  import "../../compound-v2-fork/PriceOracle.sol";
10: import "../../BathHouseV2.sol";
11: import "../../RubiconMarket.sol";
```
- [FeeWrapper.sol#L4-L5](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/FeeWrapper.sol#L4-L5)
```js
File: contracts/utilities/FeeWrapper.sol

4:  import "@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol";
5:  import "./RubiconRouter.sol";
```
Recommendation
```import {contract1 , contract2} from "filename.sol";```
# 23. Use of ```bytes.concat()``` instead of ```abi.encodePacked()```
- [RubiconMarket.sol#L369](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L369)
- [RubiconMarket.sol#L400](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L400)
- [RubiconMarket.sol#L423](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L423)
- [RubiconMarket.sol#L442](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L442)
- [RubiconMarket.sol#L476](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L476)
- [RubiconMarket.sol#L555](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L555)
```js
File: contracts/RubiconMarket.sol

369:     keccak256(abi.encodePacked(_offer.pay_gem, _offer.buy_gem)),

400:     keccak256(abi.encodePacked(_offer.pay_gem, _offer.buy_gem)),

423:     keccak256(abi.encodePacked(_offer.pay_gem, _offer.buy_gem)),

442:     keccak256(abi.encodePacked(_offer.pay_gem, _offer.buy_gem)),

476:     keccak256(abi.encodePacked(_offer.pay_gem, _offer.buy_gem)),

555:     keccak256(abi.encodePacked(pay_gem, buy_gem)),
```
# 24. For functions, follow Solidity standard naming conventions (internal function style rule)
- [RubiconMarket.sol#L35](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L35)
- [RubiconMarket.sol#L46](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L46)
- [RubiconMarket.sol#L50](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L50)
- [RubiconMarket.sol#L54](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L54)
- [RubiconMarket.sol#L58](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L58)
- [RubiconMarket.sol#L62](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L62)
- [RubiconMarket.sol#L66](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L66)
- [RubiconMarket.sol#L70](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L70)
- [RubiconMarket.sol#L77](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L77)
- [RubiconMarket.sol#L81](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L81)
- [RubiconMarket.sol#L85](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L85)
- [RubiconMarket.sol#L89](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L89)
```js
File: contracts/RubiconMarket.sol

35:    function isAuthorized(address src) internal view returns (bool) {

46:    function add(uint256 x, uint256 y) internal pure returns (uint256 z) {

50:    function sub(uint256 x, uint256 y) internal pure returns (uint256 z) {

54:    function mul(uint256 x, uint256 y) internal pure returns (uint256 z) {

58:    function min(uint256 x, uint256 y) internal pure returns (uint256 z) {

62:    function max(uint256 x, uint256 y) internal pure returns (uint256 z) {

66:    function imin(int256 x, int256 y) internal pure returns (int256 z) {

70:    function imax(int256 x, int256 y) internal pure returns (int256 z) {

77:    function wmul(uint256 x, uint256 y) internal pure returns (uint256 z) {

81:    function rmul(uint256 x, uint256 y) internal pure returns (uint256 z) {

85:    function wdiv(uint256 x, uint256 y) internal pure returns (uint256 z) {

89:    function rdiv(uint256 x, uint256 y) internal pure returns (uint256 z) {

```

- [Position.sol#L125](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/poolsUtility/Position.sol#L125)
```js
File: contracts/utilities/poolsUtility/Position.sol

125:    function openPosition(
            address asset,
            address quote,
            uint256 initMargin,
            uint256 leverage
        ) internal returns (bool OK) {
```
The above codes don’t follow Solidity’s standard naming convention,

internal and private functions : the mixedCase format starting with an underscore (_mixedCase starting with an underscore)
# 25. Extra code comments.
Should be resolved before deployment use it or remove it.
- [RubiconMarket.sol#L107-L116](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L107-L116)
- [RubiconMarket.sol#L140-L150](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L140-L150)
- [RubiconMarket.sol#L163-L172](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L163-L172)
- [RubiconMarket.sol#L187-L195](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L187-L195)
- [RubiconMarket.sol#L386-L396](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L386-L396)
- [RubiconMarket.sol#L409-L417](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L409-L417)
- [RubiconMarket.sol#L464-L472](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L464-L472)
- [RubiconMarket.sol#L542-L551](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L464-L472)
- [RubiconMarket.sol#L1343-L1359](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1343-L1359)
```js
File: contracts/RubiconMarket.sol

107:    /// event LogMake(
        ///     bytes32 indexed id,
        ///     bytes32 indexed pair,
        ///     address indexed maker,
        ///     ERC20 pay_gem,
        ///     ERC20 buy_gem,
        ///     uint128 pay_amt,
        ///     uint128 buy_amt,
        ///     uint64 timestamp
116:    /// );

140:    /// event LogTake(
        ///     bytes32 id,
        ///     bytes32 indexed pair,
        ///     address indexed maker,
        ///     ERC20 pay_gem,
        ///     ERC20 buy_gem,
        ///     address indexed taker,
        ///     uint128 take_amt,
        ///     uint128 give_amt,
        ///     uint64 timestamp
150:    /// );

163:    /// event LogKill(
        ///     bytes32 indexed id,
        ///     bytes32 indexed pair,
        ///     address indexed maker,
        ///     ERC20 pay_gem,
        ///     ERC20 buy_gem,
        ///     uint128 pay_amt,
        ///     uint128 buy_amt,
        ///     uint64 timestamp
172:    /// );

187:    /// event FeeTake(
        ///     bytes32 indexed id,
        ///     bytes32 indexed pair,
        ///     ERC20 asset,
        ///     address indexed taker,
        ///     address feeTo,
        ///     uint256 feeAmt,
        ///     uint64 timestamp
195:    /// );

386:     /// emit LogTake(
        ///     bytes32(id),
        ///     keccak256(abi.encodePacked(_offer.pay_gem, _offer.buy_gem)),
        ///     _offer.owner,
        ///     _offer.pay_gem,
        ///     _offer.buy_gem,
        ///     msg.sender,
        ///     uint128(quantity),
        ///     uint128(spend),
        ///     uint64(block.timestamp)
396:    /// );
        
409     /// emit FeeTake(
        ///     bytes32(id),
        ///     keccak256(abi.encodePacked(_offer.pay_gem, _offer.buy_gem)),
        ///     _offer.buy_gem,
        ///     msg.sender,
        ///     feeTo,
        ///     fee,
        ///     uint64(block.timestamp)
417:    /// );

464:    /// emit LogKill(
        ///     bytes32(id),
        ///     keccak256(abi.encodePacked(_offer.pay_gem, _offer.buy_gem)),
        ///     _offer.owner,
        ///     _offer.pay_gem,
        ///     _offer.buy_gem,
        ///     uint128(_offer.pay_amt),
        ///     uint128(_offer.buy_amt)
472:    /// );

542:    /// emit LogMake(
        ///     bytes32(id),
        ///     keccak256(abi.encodePacked(pay_gem, buy_gem)),
        ///     msg.sender,
        ///     pay_gem,
        ///     buy_gem,
        ///     uint128(pay_amt),
        ///     uint128(buy_amt),
        ///     uint64(block.timestamp)
551:    /// );

1343    // // Make a new offer without putting it in the sorted list.
        // // Takes funds from the caller into market escrow.
        // // Keepers should call insert(id,pos) to put offer in the sorted list.
        // function _offeru(
        //     uint256 pay_amt, //maker (ask) sell how much
        //     ERC20 pay_gem, //maker (ask) sell which token
        //     uint256 buy_amt, //maker (ask) buy how much
        //     ERC20 buy_gem, //maker (ask) buy which token
        //     address owner,
        //     address recipient
        // ) internal returns (uint256 id) {
        //     require(_dust[address(pay_gem)] <= pay_amt);
        //     id = super.offer(pay_amt, pay_gem, buy_amt, buy_gem, owner, recipient);
        //     _near[id] = _head;
        //     _head = id;
        //     emit LogUnsortedOffer(id);
1359    // }
```
# 26. Mark visibility of ```initialize(…)``` functions as external.
Description
External instead of public would give more the sense of the init(…) functions to behave like a constructor (only called on deployment, so should only be called externally).

Security point of view, it might be safer so that it cannot be called internally by accident in the child contract.

It might cost a bit less gas to use external over public.

It is possible to override a function from external to public (= “opening it up”) ✅

but it is not possible to override a function from public to external (= “narrow it down”). ❌

For above reasons you can change ```initialize(…)``` to external.

[OpenZeppelin](https://github.com/OpenZeppelin/openzeppelin-contracts/issues/3750)
- [RubiconMarket.sol#L700](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L700)
```js
File: contracts/RubiconMarket.sol

700:    function initialize(address _feeTo) public {
701:        require(!initialized, "contract is already initialized");
702:        require(_feeTo != address(0));

704:        /// @notice The market fee recipient
705:        feeTo = _feeTo;

707:        owner = msg.sender;
708:         emit LogSetOwner(msg.sender);

710:        /// @notice The starting fee on taker trades in basis points
711:        feeBPS = 1;

713:       initialized = true;
714:        matchingEnabled = true;
715:        buyEnabled = true;
716:    }
```
# 27. Use underscores for number literals.
There is occasions where certain number have been hardcoded, either in variable or in the code itself. Large numbers can become hard to read.
- [Position.sol#L459](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/poolsUtility/Position.sol#L459)
- [Position.sol#L481](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/poolsUtility/Position.sol#L481)
- [Position.sol#L490](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/poolsUtility/Position.sol#L490)
```js
File: contracts/utilities/poolsUtility/Position.sol

459:        uint256 _fee = _maxFill.mul(rubiconMarket.getFeeBPS()).div(10000);

481:        uint256 _fee = _minFill.mul(_feeBPS).div(10000);

490:        _fee = _payAmount.mul(_feeBPS).div(10000);
```
# 28. Require statements missing strings
Require statements should have descriptive strings to describe why the revert occurs.
- [RubiconMarket.sol#L246](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L246)
- [RubiconMarket.sol#L252](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L252)
- [RubiconMarket.sol#L253](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L253)
- [RubiconMarket.sol#L265](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L265)
- [RubiconMarket.sol#L460](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L460)
- [RubiconMarket.sol#L461](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L461)
- [RubiconMarket.sol#L488](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L488)
- [RubiconMarket.sol#L519-L525](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L519-L525)
- [RubiconMarket.sol#L538](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L538)
- [RubiconMarket.sol#L565](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L565)
- [RubiconMarket.sol#L581](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L581)
- [RubiconMarket.sol#L598](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L598)
- [RubiconMarket.sol#L604-L605](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L604-L605)
- [RubiconMarket.sol#L611](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L611)
- [RubiconMarket.sol#L612](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L612)
- [RubiconMarket.sol#L702](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L702)
- [RubiconMarket.sol#L753](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L753)
- [RubiconMarket.sol#L757](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L757)
- [RubiconMarket.sol#L835](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L835)
- [RubiconMarket.sol#L877](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L877)
- [RubiconMarket.sol#L938](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L938)
- [RubiconMarket.sol#L940](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L940)
- [RubiconMarket.sol#L1034](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1034)
- [RubiconMarket.sol#L1075](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1075)
- [RubiconMarket.sol#L1136](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1136)
- [RubiconMarket.sol#L1169](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1169)
- [RubiconMarket.sol#L1184](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1184)
- [RubiconMarket.sol#L1194](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1194)
- [RubiconMarket.sol#L1209](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1209)
- [RubiconMarket.sol#L1226](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1226)
- [RubiconMarket.sol#L1366](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1366)
- [RubiconMarket.sol#L1410](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1410)
- [RubiconMarket.sol#L1412](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1412)
- [RubiconMarket.sol#L1419](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1419)
- [RubiconMarket.sol#L1428](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1428)
- [RubiconMarket.sol#L1477](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1477)
```js
File: contracts/RubiconMarket.sol

246:        require(isActive(id));

252:        require(isActive(id));
253:        require(
254:            (msg.sender == getOwner(id)) ||
255:                (msg.sender == getRecipient(id) && getOwner(id) == address(0))
256:        );

265:        require(!locked);

460:        ? require(_offer.pay_gem.transfer(_offer.recipient, _offer.pay_amt))
461:        : require(_offer.pay_gem.transfer(_offer.owner, _offer.pay_amt));

488:        require(cancel(uint256(id)));

519:        require(uint128(pay_amt) == pay_amt);
520:        require(uint128(buy_amt) == buy_amt);
521:        require(pay_amt > 0);
522:        require(pay_gem != ERC20(address(0))); /// @dev Note, modified from: require(pay_gem != ERC20(0x0)) which compiles in 0.7.6
523:        require(buy_amt > 0);
524:        require(buy_gem != ERC20(address(0))); /// @dev Note, modified from: require(buy_gem != ERC20(0x0)) which compiles in 0.7.6
525:        require(pay_gem != buy_gem);

538:        require(pay_gem.transferFrom(msg.sender, address(this), pay_amt));

565:        require(buy(uint256(id), maxTakeAmount));

581:        require(amount > 0);

598:        require(!isClosed());

604:        require(isActive(id));
605:        require(!isClosed());

611:        require(isActive(id));
612:        require(
613:            (msg.sender == getOwner(id)) ||
614:                isClosed() ||
615:                (msg.sender == getRecipient(id) && getOwner(id) == address(0))
616:        );

702:        require(_feeTo != address(0));

753:        require(buy(uint256(id), maxTakeAmount));

757:        require(cancel(uint256(id)));

835:        require(_dust[address(pay_gem)] <= pay_amt);

877:        require(_unsort(id));

938:        require(!locked);

940:        require(
                !isActive(id) &&
                    _rank[id].delb != 0 &&
                    _rank[id].delb < block.number - 10
            );

1034:        require(!locked);

1075:        require(!locked);

1136:        require(offerId != 0); //Fails if there are not enough offers to complete

1169:        require(offerId != 0); //Fails if there are not enough offers to complete

1184:        require(buyEnabled);

1194:        require(super.buy(id, amount));

1209:        require(id > 0);

1226:        require(id > 0);

1366:        require(isActive(id));

1410:        require(_span[pay_gem][buy_gem] > 0);

1412:        require(
                _rank[id].delb == 0 && //assert id is in the sorted list
                    isOfferSorted(id)
             );

1419:        require(_rank[_rank[id].next].prev == id);

1428:        require(_rank[_rank[id].prev].next == id);

1477:        require(newFeeTo != address(0));
```
- [BathBuddy.sol#L88](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/periphery/BathBuddy.sol#L88)
```js
File: contracts/periphery/BathBuddy.sol

88:        require(msg.sender == owner);
```
- [Position.sol#L340](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/poolsUtility/Position.sol#L340)
```js
File: contracts/utilities/poolsUtility/Position.sol

340:        require(_errs[0] == 0);

```
# 29. Instead of using multiple same ```require``` statement, create a modifier.
- [RubiconMarket.sol#L2](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L2)
```js
File: contracts/RubiconMarket.sol

265:        require(!locked);

1034:        require(!locked);

1075:        require(!locked);
```
# 30. Floating pragma
Contracts should be deployed with the same compiler version and flags that they have been tested with thoroughly. Locking the pragma helps to ensure that contracts do not accidentally get deployed using, for example, an outdated compiler version that might introduce bugs that affect the contract system negatively.
- [BathBuddy.sol#L2](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/periphery/BathBuddy.sol#L2)
```js
File: contracts/periphery/BathBuddy.sol

2:  pragma solidity ^0.8.0;
```
- [RubiconMarket.sol#L2](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L2)
```js
File: contracts/RubiconMarket.sol

2:  pragma solidity ^0.8.9;
```
# 31.  Constant values such as a call to ```keccak256()```, should used to ```immutable``` rather than ```constant```
- [RubiconMarket.sol#L232](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L232)
```js
File: contracts/RubiconMarket.sol

232:    bytes32 internal constant MAKER_FEE_SLOT = keccak256("WOB_MAKER_FEE");
```
# 32. Generate perfect code headers every time
Description:
I recommend using header for Solidity code layout and readability

[Headers](https://github.com/transmissions11/headers)

```js
/*//////////////////////////////////////////////////////////////
                           TESTING 123
//////////////////////////////////////////////////////////////*/
```
# 33. Contract layout
The Solidity style guide
[recommends](https://docs.soliditylang.org/en/v0.8.17/style-guide.html#order-of-layout) 
declaring state variables before all functions. Consider moving the state variables from the GovNFT instance highlighted below to the top of the contract.
- [BathBuddy.sol#L87-L107](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/periphery/BathBuddy.sol#L87-L107)
- [BathBuddy.sol#L246-L266](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/periphery/BathBuddy.sol#L246-L266)
```js
File: contracts/periphery/BathBuddy.sol
87:    modifier onlyOwner() {
            require(msg.sender == owner);
            _;
        }

        // TODO: do we need this?
        // Enforce only soul-bound Bath Token has calling rights
        modifier onlyBuddy() {
            require(
                msg.sender == myBathTokenBuddy &&
                    msg.sender != address(0) &&
                    friendshipStarted,
                "You are not my buddy!"
            );
            _;
        }

        modifier onlyBathHouse() {
            require(msg.sender == bathHouse, "You are not my beloved bath house!");
            _;
107:    }

    // Rewards set here
246:    modifier updateReward(address account, address token) {
            rewardsPerTokensStored[token] = rewardPerToken(token);
            lastUpdateTime[token] = lastTimeRewardApplicable(token);
            if (account != address(0)) {
                tokenRewards[token][account] = earned(account, token);
                userRewardsPerTokenPaid[token][account] = rewardsPerTokensStored[
                    token
                ];
            }
            _;
        }

        /* ========== EVENTS ========== */

        event RewardAdded(uint256 reward);
        event Staked(address indexed user, uint256 amount);
        event Withdrawn(address indexed user, uint256 amount);
        event RewardPaid(address indexed user, uint256 reward);
        event RewardsDurationUpdated(uint256 newDuration);
266:    event Recovered(address token, uint256 amount);
```
- [RubiconMarket.sol#L30-L33](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L30-L33)
- [RubiconMarket.sol#L74-L75](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L74-L75)
- [RubiconMarket.sol#L234-L242](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L234-L242)
- [RubiconMarket.sol#L634-L657](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L634-L657)
- [RubiconMarket.sol#L686-L690](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L686-L690)
- [RubiconMarket.sol#L719-L729](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L719-L729)
```js
File: contracts/RubiconMarket.sol

//Modifiers
30:    modifier auth() {
31:        require(isAuthorized(msg.sender), "ds-auth-unauthorized");
23:        _;
33:    }

//State variables
74:    uint256 constant WAD = 10 ** 18;
75:    uint256 constant RAY = 10 ** 27;

//Type declarations must come first.
234:    struct OfferInfo {
        uint256 pay_amt;
        ERC20 pay_gem;
        uint256 buy_amt;
        ERC20 buy_gem;
        address recipient;
        uint64 timestamp;
        address owner;
242:    }

//Replace event with modifier
634:    event LogNote(
            bytes4 indexed sig,
            address indexed guy,
            bytes32 indexed foo,
            bytes32 indexed bar,
            uint256 wad,
            bytes fax
        ) anonymous;

        modifier note() {
            bytes32 foo;
            bytes32 bar;
            uint256 wad;

            assembly {
                foo := calldataload(4)
                bar := calldataload(36)
                wad := callvalue()
            }

            emit LogNote(msg.sig, msg.sender, foo, bar, wad, msg.data);

            _;
657:    }

686:    struct sortInfo {
            uint256 next; //points to id of next higher offer
            uint256 prev; //points to id of previous lower offer
            uint256 delb; //the blocknumber where this entry was marked for delete
690:    }

719:    modifier can_cancel(uint256 id) override {
            require(isActive(id), "Offer was deleted or taken, or never existed.");
            require(
                isClosed() ||
                    msg.sender == getOwner(id) ||
                    id == dustId ||
                    (msg.sender == getRecipient(id) && getOwner(id) == address(0)),
                "Offer can not be cancelled because user is not owner, and market is open, and offer sells required amount of tokens."
            );
            _;
729:    }
```
- [Position.sol#L20](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/poolsUtility/Position.sol#L20)
```js
File: contracts/utilities/poolsUtility/Position.sol

//after struct declarations
20:    uint256 public lastPositionId;
```
# 34. Declare interfaces on separate files
- IBathToken in [V2Migrator.sol](https://github.com/code-423n4/2023-04-rubicon/blob/main/contracts/V2Migrator.sol)
- IBathBuddy in [BathBuddy.sol](https://github.com/code-423n4/2023-04-rubicon/blob/main/contracts/periphery/BathBuddy.sol)
# 35. Lack of spacing in comment
- More than one instance in this [RubiconMarket.sol](https://github.com/code-423n4/2023-04-rubicon/blob/main/contracts/RubiconMarket.sol)
- [BathBuddy.sol#L55](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/periphery/BathBuddy.sol#L55)
```js
File: contracts/periphery/BathBuddy.sol

55:    mapping(address => uint256) public lastUpdateTime; //Token specific
```
# 36.  Use scientific notation (e.g. ```1e18```) rather than exponentiation (e.g. ```10**18```)
While the compiler knows to optimize away the exponentiation, it’s still better coding practice to use idioms that do not require compiler optimization, if they exist.
- [RubiconMarket.sol#L1058](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1058)
- [RubiconMarket.sol#L1060](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1060)
- [RubiconMarket.sol#L1099](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1099)
- [RubiconMarket.sol#L1101](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1101)
- [RubiconMarket.sol#L1141](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1141)
- [RubiconMarket.sol#L1144](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1144)
- [RubiconMarket.sol#L1175](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1175)
- [RubiconMarket.sol#L1177](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1177)
```js
File: contracts/RubiconMarket.sol

1057:       uint256 baux = rmul(
1058:            mul(pay_amt, 10 ** 9),
1059:            rdiv(offers[offerId].pay_amt, offers[offerId].buy_amt)
1060:       ) / 10 ** 9;

1098:       rmul(
1099:            mul(buy_amt, 10 ** 9),
1100:            rdiv(offers[offerId].buy_amt, offers[offerId].pay_amt)
1101:       ) / 10 ** 9

1141:        rmul(
1142:            mul(pay_amt, 10 ** 9),
1143:            rdiv(offers[offerId].pay_amt, offers[offerId].buy_amt)
1144:        ) / 10 ** 9

1175        mul(buy_amt, 10 ** 9),
1176            rdiv(offers[offerId].buy_amt, offers[offerId].pay_amt)
1177        ) / 10 ** 9
```
- [Position.sol#L331](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/poolsUtility/Position.sol#L331)
```js
File: contracts/utilities/poolsUtility/Position.sol

331        ).div(10 ** 18);
```
# 37. Loss of precision due to rounding
- [RubiconMarket.sol#L319](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L319)
- [RubiconMarket.sol#L1317](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/RubiconMarket.sol#L1317)
```js
File: contracts/RubiconMarket.sol

31:        uint256 spend = mul(quantity, _offer.buy_amt) / _offer.pay_amt;

1317:      t_pay_amt = mul(t_buy_amt, t_pay_amt) / t_buy_amt_old;
```
- [FeeWrapper.sol#L41](https://github.com/code-423n4/2023-04-rubicon/blob/511636d889742296a54392875a35e4c0c4727bb7/contracts/utilities/FeeWrapper.sol#L41)
```js
File: contracts/utilities/FeeWrapper.sol

41:        fees[i] = (tokenAmounts[i] * feeValue) / feeType;
```
